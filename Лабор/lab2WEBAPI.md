**Програмна інженерія в системах управління. Лабораторний практикум.** Автор і лектор: Олександр Пупена 

| [<- до лаборних робіт](README.md) | [на основну сторінку курсу](../README.md) |
| --------------------------------- | ----------------------------------------- |
| [<- 1 частина](lab2MQTT.md)       |                                           |

# ЛР3.Ч2. Використання WEB API та Web-сокетів

**Увага! Більшість ресурсів є захищеними та потребують автентифікації, шифрування і т.п. У цій роботі усі інтерфейси є відкритими, тому не можуть в чистому вигляді використовуватися в промислових умовах!**  

## 1. Використання відкритого WEB API 

Багато застосунків в Інтернеті мають відкритий API інтерфейс для доступу до різних ресурсів як сервісів чи даних. Більшість з них є платними і надаються за підпискою. Деякі з них мають можливість обмеженого користування на певний період чи на певну продуктивність. 

Node-RED  може представляти як бік клієнта так і сервера HTTP. У більшості випадків на рівні Edge він представляє бік клієнта. Дана частина практичного завдання призначена для побудови в Node-RED WEB-клієнта для доступу через API до інших застосунків. 

### 1.1. Знайомство з сервісами IPAPI

У якості прикладу серверного Веб-застосунку використовуватиметься  [IPA-PI](https://ip-api.com/), який дає можливість визначити деталі місця розташування за IP адресою. Це можна зробити через сторінку Веб-інтерфейсу, або через відкритий API-інтерфейс. Повний опис API з форматом JSON доступний за [посиланням](https://ip-api.com/docs/api:json).

- [ ] Зайдіть на сторінку за посиланням https://ip-api.com. 
- [ ] Ознайомтеся зі змістом сторінки. Зверніть увагу на ту інформацію, яка надається по IP-адресі, а також на значення Вашої білої адреси IP, вірніше від якої Ваш пристрій спілкується в Інтернеті. 

Слід розуміти, що у більшості випадків видима IP-адреса – це одна з адрес провайдера, що надає послуги Інтернету, тому координати будуть саме цього провайдера. 

- [ ] Подивіться на приклад запиту і відповіді в форматі JSON. 
- [ ] Зайдіть на сайт https://www.myip.com/, подивіться яка інформація там надається.
- [ ] Ознайомтеся з API-сервісом https://www.myip.com/api-docs/. 

### 1.2. Робота з онлайн утилітами для API-тестування

Для тестування API Ви можете користуватися будь якою утилітою, наприклад  https://apitester.com/ або http://restninja.io/ 

- [ ] Відкрийте сторінку однієї з утиліт <https://apitester.com> або <http://restninja.io>  
- [ ] Для перевірки роботи API  https://www.myip.com введіть в поле адреси https://api.myip.com у метод – «GET», і натисніть «SEND» або "TEST" в залежності від вибраного програми. 
- [ ] Проаналізуйте відповідь
- [ ] Повторіть те саме з адресою <http://ip-api.com/8.8.8.8/json/> . 
- [ ] Повторіть те саме зі своєю білою IP-адресою, або просто відправивши http://ip-api.com/json/. Порівняйте отримані результати з тими, що показані на сторінці https://ip-api.com 

### 1.3. Створення клієнту для IPAPI в Node-RED 

- [ ] Запустіть Node-RED, створіть нову вкладку з назвою `IPAPI`. 
- [ ] самостійно реалізуйте програму, яка буде використовуючи вузол “Http request” для витягування інформації про білий IP, використовуючи сервіси <https://www.myip.com>.   
- [ ] Аналогічно зробіть для сервісів <http://ip-api.com/json/>. Зверніть увагу, що **IP-API може повернути негативну відповідь** - це може бути спричинено обмеженим використанням безкоштовного сервісу. 

Зверніть увагу, що **IPAPI може повернути негативну відповідь. Подивіться поля заголовків**  https://apitester.com/  в запиті, і заповніть їх аналогічно у вузлі `headers` 

![рис.11.](WEBAPIMedia/Рисунок11.png)     

рис.1.

- [ ] Зробіть копію фрагменту екрану виводу у вікні відлагодження і збережіть для звіту.

## 2. Робота з FRED - хмарним сервісом Node-RED  

На хмарних платформах, зокрема IBM, інструмент Node-RED можна використовувати як середовище для розробки програмних додатків. Є також можливість скористатися окремим хмарним сервісом FRED https://fred.sensetecnic.com/ . Ця платформа має безкоштовну ліцензію, обмежену 50-ма вузлами та потребує перезапуску (працює добу, після чого треба перезапускати). Для користування платформою потрібна безкоштовна реєстрація.

Даний сервіс буде використовуватися в лабораторних роботах в тому випадку, коли необхідно буде мати серверний додаток в Інтернет. 

### 2.1. Реєстрація на FRED.

- [ ] Зайдіть на https://fred.sensetecnic.com/ ознайомтеся з умовами ліцензії. 

- [ ] Зайдіть на https://users.sensetecnic.com/register , зареєструйтеся:

- введіть необхідні дані в поля реєстрації, 
- виберіть PLAN Fred Short.
- виставте одну із опцій «How would you describe your use of FRED? (select one)»
- виставте одну або кілька опцій «What industry or area of interest are you using FRED for? (select all that apply)»
- виставте опцію «I agree to the Terms of Use»
- виставте опцію «Я не робот»
- натисніть “Create An Account”
- через кілька хвилин на пошту прийде лист від [info@sensetecnic.com](mailto:info@sensetecnic.com) , в якому буде посилання  «Verify your email address»  для активації аккаунту

### 2.2. Запуск FRED.

- [ ] Зайдіть на https://fred.sensetecnic.com/ і якщо Node-RED не виконується, запустіть його натисканням “Start Instance”. Сховайте ліву бокову панель кнопкою «Togle slidebar» (стрілка в лівому нижньому кутку екрану)

- [ ] Видаліть усі вузли в потоці, які вставлені туди при створенні аккаунту.

- [ ] Створіть невеличку програму, наприклад, яка складається з двох з’єднаних вузлів «inject» та «debug», та перевірте її роботу.   

## 3. Використання WEB-сокетів 

- [ ] Ознайомтеся з принципами роботи WEB-сокетів  (даються в лекційному матеріалі).

В даній частині лабораторної роботи WEB-сокети будуть використовуватися для наступних цілей:

- зв’язку між локальним (ПК) та віддаленим (FRED) Node-RED, тобто в якості подовжувача зв’язку між потоками
- зв’язку Node-RED з застосунками в Інтернет 
- зв’язку Node-RED з застосунками на мобільних пристроях 

При роботі з HTTP (у тому числі WEB-сокетами) FRED, як посередник, передає всі повідомлення з Інтернету на екземпляр Node-RED. Щоб відправити запит до конкретного екземпляру, FRED використовує ім'я користувача в заголовку для **приватних** вузлів введення API або URL для **загальнодоступних** вузлів вводу Websockets. 

Для створення загальнодоступного серверного вузла Websocket, необхідно в конфігураційному вузлі Websocket в URL-адресі прослухування вказати префікс «/public/». Тоді можна буде отримати доступ до websocket в

```http
wss://{ім'я користувача}.fred.sensetecnic.com/api/public/{custom_endpoint_name}.
```

Наприклад, вхідний вузол websocket, налаштований на шлях /public /data, створений користувачем mike, буде доступний як 

```http
wss://mike.fred.sensetecnic.com/api/public/data
```

Для того, щоб клієнт Websockets отримував доступ до захищених вузлів вводу Websocket у потоках, необхідно надати своє ім'я користувача та пароль, використовуючи базову аутентифікацію, або ключ API з вашими запитами. Щоб зробити запит до захищеного вузла вводу веб-сокету, ім'я користувача та ключ API повинні бути додані до заголовків запиту: x-auth-user та x-auth-key. В даній лабораторній роботі не будуть використовуватися захищені приватні з’єднання. 
З деталями роботи з Веб-сокетами на платформі FRED, можна ознайомитися [тут](http://docs.sensetecnic.com/fred/websocket-access/). 

###  3.1. Створення серверного WEB-сокету в FRED.

- [ ] В Node-RED на платформі FRED створіть вхідний серверний “WebSocket In”  та з’єднайте його з вузлом “Debug” (рис.2) 

![рис.12.](WEBAPIMedia/Рисунок12.png) 

рис.2.

- [ ] Відкрийте Веб-інтерфейс Dashboard FRED, скопіюйте адресу, вона повинна мати вигляд:

```http
https://account_name.fred.sensetecnic.com/api/ui/
```

де *account _name –* ім’я вашої реєстрації 

### 3.2.Створення клієнтського WEB-сокету в локальному Node-RED.

- [ ] Запустіть Node-RED на локальному ПК. Створіть новий потік, в ньому розмістіть два вузли – клієнтський “WebSocket out”  та “Inject” (рис.3). Налаштуйте відповідно до вашого серверного сокету. Перевірте роботу з’єднання. Зробіть копію екрану потоку на FRED, на якій видно адресу вашого аккаунту і наявність з’єднання – зелений напис «connected». Добавте його до звіту.  

 ![рис.13.](WEBAPIMedia/Рисунок13.png) 

 рис.3.

### 3.3. Перевірка роботи сервісів WEB-сокету через онлайн утиліти.

- [ ] Самостійно зробіть тестування клієнтського WEB-сокету в локальному Node-RED, під’єднавшись до `wss://echo.websocket.org`. Цей сервер передбачає ехо-відповіді на запити, тому для перевірки його роботи необхідно як вхідний так і вихідний клієнтські сокети.  

- [ ] Самостійно зробіть тестування створеного раніше серверного WEB-сокету на FRED через севіс https://www.websocket.org/echo.html 

## Посилання

- [Погода по Україні і світі за HTTP-запитом](https://meteoprog.ua/ru/weather/Mukacheve/actual/) 

[<- 1 частина](lab2MQTT.md)